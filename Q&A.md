# 项目核心流程问答 (Q&A)

本文档旨在通过问答的形式，梳理和澄清从建立模型到解算结果的完整工作流程。

---

### **问1：我的实测TS数据是用来做什么的？是用来建立TS与入射角度的关系式吗？**

**答：完全正确。**

这是您实测数据的核心价值。您用这些宝贵的、带有噪声和不确定性的真实数据点，通过多项式拟合等方法，提炼出一个干净、连续的**“声学模型”函数 `TS = f(θ)`**。

这个函数是您整个体系的基石之一，它代表了鱿鱼这种生物对声波的“反应”规律。因为它是基于您自己的数据，所以它比任何文献里的通用公式都更贴合您的实际情况。

---

### **问2：我根据这个关系式，把鱿鱼每个游泳姿态的5个波束下的TS做估算，能做出一个什么模型？**

**答：您最终做出的是一个“正向物理模型”的查找表（Look-Up Table, LUT）。**

这个过程是这样的：

1.  **输入**: 一个游泳状态 `State(ψ, τ)`。
2.  **步骤 A (几何模型)**: `State(ψ, τ)` => 计算出5个入射角 `{θ_N, θ_S, ...}`。
3.  **步骤 B (声学模型)**: 将这5个入射角分别代入您上一步建立的 `TS = f(θ)` 函数，得到5个“理论TS值”。
4.  **步骤 C (不确定性模型)**: 为这5个理论TS值分别加上由波束宽度等因素引起的随机扰动。对每个状态重复此过程上千次。

**最终产出的模型就是：**
一个巨大的、多维的**查找表（LUT）**。这个查找表的结构是：
`LUT[ψ, τ] = {TS_N的PDF, TS_S的PDF, ...}`

简单来说，这个模型能回答一个问题：“**如果**一只鱿鱼处于 `(ψ, τ)` 这个姿态，那么我**预期**在五个波束上会分别测量到什么样的TS值（以及其概率分布）？”。这个模型我们称之为**“正向模型”**。

---

### **问3：最后我需要从实际探测数据中，统计出5个波束的TS分布，根据这个分布就能逆推游泳姿态吗？**

**答：方向正确，但有一个关键澄清：您不是用实测数据的“分布”去逆推，而是用**单次探测**得到的**一组（5个）TS值**去逆推。**

逆推（反演）的实际过程是这样的：

1.  **获取单次实测数据**: 在某一时刻，您的声呐探测到了一个目标，并同时给出了5个测量值：`TS_obs = {TS_N_obs, TS_S_obs, TS_W_obs, TS_E_obs, TS_V_obs}`。

2.  **进行“匹配”**：您拿着这5个实测值，去和您在第二步建立的那个巨大的**“正向模型”查找表（LUT）**做比较。

3.  **使用解算方法**：您遍历查找表中的**每一个** `State(ψ, τ)`，然后用我们之前讨论的方法（如卡方最小化或最大似然估计）来回答这个问题：
    > “我手上的这5个实测值，由查找表里哪个 `State(ψ, τ)` 所对应的5个TS概率分布（PDF）来‘解释’最为合理？”

4.  **得出结论**：
    *   如果用**卡方最小化**，那么“最合理”的那个 `State(ψ, τ)` 就是让 `χ²` 误差最小的那个。
    *   如果用**最大似然估计**，那么“最合理”的那个 `State(ψ, τ)` 就是让出现您这5个实测值的总概率 `L` 最大的那个。

这个“最合理”的 `State(ψ, τ)`，就是您最终逆推出（解算出）的鱿鱼游泳状态。

---

### **总结：完整流程**

1.  **建模**: 用您的实测数据，建立 `TS = f(θ)` 声学模型。
2.  **推演**: 结合几何关系和声学模型，建立一个“正向”的、包含所有可能性的 `(ψ, τ) -> {5个TS分布}` 的查找表（LUT）。
3.  **反演**: 拿单次的5个实测TS值，去查找表里“反向查询”，找到与之最匹配的 `(ψ, τ)` 作为答案。

---

### **问4：我想用贝叶斯方法，具体来说应该怎么应用？**

**答：** 应用贝叶斯方法是一个非常严谨的选择，它能提供最丰富的结果信息。核心是计算每个可能姿态的“后验概率”，然后找到概率最高的姿态作为答案。

**核心公式：** `后验概率 ∝ 似然度 × 先验概率`

#### **第一步：准备“似然度”模型 `P(Data | State)`**

这是整个流程中最关键的准备工作。您需要一个模型，它能回答：“**如果**鱿鱼处于 `State(ψ, τ)`，那么我测到 `TS_obs` 的概率是多少？” 这个模型就源于您之前生成的查找表（LUT）。

1.  **生成包含PDF信息的查找表**：
    在对每个 `State(ψ, τ)` 进行上千次微观模拟后，您得到的5组TS样本，需要为它们分别建立一个概率密度函数（PDF）模型。

2.  **选择PDF模型（二选一）**：
    *   **方法A（简单高效）- 正态分布**：假设TS样本服从正态分布，计算并存储每个样本集的**均值 `μ`** 和**标准差 `σ`**。
    *   **方法B（更灵活）- 核密度估计 (KDE)**：如果TS分布不规则，使用KDE从样本数据中拟合出一个非参数的PDF。在Python中，`scipy.stats.gaussian_kde` 是一个很好的工具。

**产出**：一个查找表，其中每个 `(ψ, τ)` 都对应5个可以计算概率密度的PDF模型。

#### **第二步：定义“先验概率”模型 `P(State)`**

先验概率是您在看到任何测量数据之前，对鱿鱼游泳姿态的“初始信念”。它是一个与您状态空间同样大小的二维数组（例如 360x181）。

*   **无信息先验**：如果您一无所知，可以假设所有 `(ψ, τ)` 状态出现的可能性都一样（一个所有值都相等的二维数组）。
*   **有信息先验（推荐）**：利用文献知识。例如，根据 `Kang et al. (2005)`，您可以构建一个倾斜角 `τ` 以 `-17.7°` 为中心的正态分布作为先验。

#### **第三步：执行贝叶斯计算（核心循环）**

当您有了一组实测数据 `TS_obs` 后，执行以下计算：

```
# 创建一个空的二维数组，用于存储后验概率（通常用对数形式）
log_posterior_map = create_empty_array(360, 181)

# 遍历所有可能的游泳状态
for ψ from 0 to 359:
    for τ from -90 to 90:
        
        # 1. 计算该状态的对数似然度 log P(Data | State)
        log_likelihood = 0
        for k in {N, S, W, E, V}:  # 遍历5个波束
            # 从LUT中获取该状态、该波束的PDF模型（例如 μ_k, σ_k）
            mu_k, sigma_k = LUT[ψ, τ, k]
            
            # 计算实测值 TS_k_obs 在这个PDF下的对数概率密度
            log_prob_k = log_pdf(TS_k_obs, mean=mu_k, std=sigma_k)
            
            # 累加
            log_likelihood += log_prob_k
            
        # 2. 获取该状态的对数先验概率 log P(State)
        log_prior = log(Prior_Map[ψ, τ])
        
        # 3. 计算对数后验概率
        log_posterior_map[ψ, τ] = log_likelihood + log_prior
```

#### **第四步：分析与使用结果**

1.  **找到最优解（最大后验估计，MAP）**：
    在 `log_posterior_map` 数组中找到**最大值**所在的位置。这个位置的 `(ψ, τ)` 坐标就是您解算出的**最可能的鱿鱼姿态**。

2.  **可视化不确定性**：
    将 `log_posterior_map` 这个二维数组绘制成一张**热力图或等高线图**。图中的高亮区域（概率高的区域）的形状和大小，直观地展示了您解算结果的可信度。如果高亮区域很集中，说明结果很确定；如果很分散，则说明不确定性很高。